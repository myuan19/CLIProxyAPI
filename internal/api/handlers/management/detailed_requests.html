<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Detailed Request Logs - CLI Proxy API</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#ffffff;--card-bg:#f3f4f6;--card-border:#e5e7eb;--text:#1f2937;--text-secondary:#6b7280;--primary:#3b82f6;--primary-hover:#2563eb;--success:#10b981;--warning:#f59e0b;--error:#ef4444;--info:#3b82f6;--badge-bg:#eef2f7;--header-key:#2563eb;--header-val:#374151;--section-label:#1f2937;--body-bg:#f3f4f6}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;padding:20px;max-width:1400px;margin:0 auto}
body.embed{background:transparent;padding:8px 4px 0 4px;max-width:none}
body.embed .back-link{display:none!important}
body.embed h1{display:none!important}
body.embed .subtitle{display:none!important}
h1{font-size:1.5rem;margin-bottom:4px}
.subtitle{color:var(--text-secondary);font-size:0.85rem;margin-bottom:20px}
.toolbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:20px;padding:16px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px}
.toggle-group{display:flex;align-items:center;gap:8px}
.toggle-label{font-size:0.85rem;color:var(--text-secondary)}
.toggle{position:relative;width:44px;height:24px;cursor:pointer}
.toggle input{opacity:0;width:0;height:0}
.toggle .slider{position:absolute;inset:0;background:#cbd5e1;border-radius:24px;transition:0.3s}
.toggle .slider:before{content:'';position:absolute;height:18px;width:18px;left:3px;bottom:3px;background:white;border-radius:50%;transition:0.3s}
.toggle input:checked+.slider{background:var(--primary)}
.toggle input:checked+.slider:before{transform:translateX(20px)}
.stats{font-size:0.8rem;color:var(--text-secondary);margin-left:auto;display:flex;gap:12px}
.filter-bar{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:16px}
select,input[type=text]{background:var(--card-bg);border:1px solid var(--card-border);color:var(--text);padding:8px 12px;border-radius:8px;font-size:0.85rem;outline:none}
select:focus,input:focus{border-color:var(--primary)}
.btn{padding:8px 16px;border:none;border-radius:8px;cursor:pointer;font-size:0.85rem;font-weight:500;transition:all 0.2s}
.btn-primary{background:var(--primary);color:white}
.btn-primary:hover{background:var(--primary-hover)}
.btn-danger{background:var(--error);color:white}
.btn-danger:hover{opacity:0.9}
.btn-sm{padding:4px 10px;font-size:0.75rem}
.btn-ghost{background:transparent;color:var(--text-secondary);border:1px solid var(--card-border)}
.btn-ghost:hover{background:var(--card-bg);color:var(--text)}
.status-chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{padding:4px 12px;border-radius:16px;font-size:0.75rem;cursor:pointer;border:1px solid var(--card-border);background:transparent;color:var(--text-secondary);transition:all 0.2s}
.chip.active{background:var(--primary);color:white;border-color:var(--primary)}
.chip:hover{border-color:var(--primary)}
.card-list{display:flex;flex-direction:column;gap:10px}
.card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;overflow:hidden;transition:border-color 0.2s}
.card:hover{border-color:#d1d5db}
.card-header{padding:14px 18px;display:flex;align-items:center;gap:12px;cursor:pointer;user-select:none}
.card-header:hover{background:rgba(0,0,0,0.02)}
.method-badge{font-weight:700;font-size:0.75rem;padding:3px 8px;border-radius:6px;background:var(--badge-bg);color:var(--info);min-width:50px;text-align:center}
.path{font-family:'JetBrains Mono',monospace;font-size:0.85rem;color:var(--text);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.status-badge{font-weight:600;font-size:0.8rem;padding:2px 10px;border-radius:12px}
.status-2xx{background:rgba(16,185,129,0.1);color:var(--success)}
.status-3xx{background:rgba(59,130,246,0.1);color:var(--info)}
.status-4xx{background:rgba(245,158,11,0.1);color:var(--warning)}
.status-5xx{background:rgba(239,68,68,0.1);color:var(--error)}
.status-0{background:var(--badge-bg);color:var(--text-secondary)}
.meta{display:flex;gap:16px;font-size:0.75rem;color:var(--text-secondary);align-items:center;flex-shrink:0}
.meta-item{display:flex;align-items:center;gap:4px}
.model-badge{font-size:0.7rem;padding:2px 8px;border-radius:6px;background:rgba(59,130,246,0.1);color:var(--primary)}
.expand-icon{color:var(--text-secondary);font-size:0.8rem;transition:transform 0.2s}
.card.expanded .expand-icon{transform:rotate(90deg)}
.card-body{display:none;padding:0 18px 18px;border-top:1px solid var(--card-border)}
.card.expanded .card-body{display:block}

/* === Section styles - shared by request/response sections === */
.section{margin-top:14px}
.section-title{font-size:0.8rem;font-weight:600;color:var(--section-label);margin-bottom:8px;display:flex;align-items:center;gap:6px;cursor:pointer;user-select:none;letter-spacing:0.3px;text-transform:uppercase}
.section-content{display:none;background:var(--body-bg);border-radius:8px;padding:12px;font-family:'JetBrains Mono',monospace;font-size:0.8rem;white-space:pre-wrap;word-break:break-all;max-height:400px;overflow:auto;color:#374151}
.section.open .section-content{display:block}
.section-title .arrow{transition:transform 0.2s;font-size:0.7rem}
.section.open .section-title .arrow{transform:rotate(90deg)}

/* === Combined request block (headers + body together) === */
.request-block{margin-top:14px;background:var(--body-bg);border-radius:8px;overflow:hidden;border:1px solid var(--card-border)}
.request-block-title{font-size:0.8rem;font-weight:600;color:var(--section-label);padding:10px 14px;display:flex;align-items:center;gap:6px;cursor:pointer;user-select:none;letter-spacing:0.3px;text-transform:uppercase;background:rgba(59,130,246,0.03);border-bottom:1px solid var(--card-border)}
.request-block-title .arrow{transition:transform 0.2s;font-size:0.7rem}
.request-block.open .request-block-title .arrow{transform:rotate(90deg)}
.request-block-content{display:none;padding:0}
.request-block.open .request-block-content{display:block}

/* === Headers in Key: Value format === */
.headers-section{padding:0}
.headers-toggle{font-size:0.75rem;color:var(--text-secondary);padding:10px 14px 6px;cursor:pointer;user-select:none;display:flex;align-items:center;gap:5px;border-bottom:1px solid rgba(0,0,0,0.05)}
.headers-toggle:hover{color:var(--text)}
.headers-toggle .arrow{transition:transform 0.2s;font-size:0.6rem}
.headers-section.open .headers-toggle .arrow{transform:rotate(90deg)}
.headers-list{display:none;padding:10px 14px;font-family:'JetBrains Mono',monospace;font-size:0.78rem;line-height:1.7}
.headers-section.open .headers-list{display:block}
.header-line{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.header-key{color:var(--header-key)}
.header-sep{color:var(--text-secondary)}
.header-val{color:var(--header-val)}

/* === Body section within request block === */
.body-content{padding:12px 14px;font-family:'JetBrains Mono',monospace;font-size:0.8rem;white-space:pre-wrap;word-break:break-all;max-height:400px;overflow:auto;color:#374151;border-top:1px solid rgba(0,0,0,0.05)}

/* === Attempt cards === */
.attempt-card{background:var(--body-bg);border:1px solid var(--card-border);border-radius:8px;padding:12px;margin-bottom:8px}
.attempt-header{display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.attempt-label{font-size:0.75rem;font-weight:600;color:var(--text)}
.attempt-status{font-size:0.7rem}
.actions{display:flex;gap:8px;margin-top:10px;align-items:center}
.api-key-tag{font-size:0.7rem;padding:2px 8px;border-radius:6px;background:rgba(107,114,128,0.1);color:var(--text-secondary)}
.timestamp{font-size:0.7rem;color:var(--text-secondary)}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-secondary)}
.empty-state h3{margin-bottom:8px;color:var(--text)}
.pagination{display:flex;justify-content:center;gap:8px;margin-top:20px;align-items:center}
.pagination span{font-size:0.85rem;color:var(--text-secondary)}
.loading{text-align:center;padding:40px;color:var(--text-secondary)}
.toast{position:fixed;bottom:20px;right:20px;padding:12px 20px;border-radius:8px;background:var(--success);color:white;font-size:0.85rem;z-index:9999;animation:fadeIn 0.3s}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.duration{font-variant-numeric:tabular-nums}
.back-link{display:inline-flex;align-items:center;gap:6px;color:var(--primary);text-decoration:none;font-size:0.85rem;margin-bottom:16px}
.back-link:hover{text-decoration:underline}

/* === Section labels for response/error === */
.section-label-success{color:var(--success)}
.section-label-error{color:var(--error)}
.section-label-info{color:var(--info)}

/* === Time range filter === */
.time-range{display:flex;align-items:center;gap:8px;margin-left:auto}
.time-presets{display:flex;gap:4px}
.time-label{font-size:0.75rem;color:var(--text-secondary)}
input[type=datetime-local]{background:var(--card-bg);border:1px solid var(--card-border);color:var(--text);padding:5px 8px;border-radius:6px;font-size:0.78rem;outline:none;width:170px}
input[type=datetime-local]:focus{border-color:var(--primary)}

/* === Auto-refresh indicator === */
.auto-refresh-group{display:flex;align-items:center;gap:8px}
.auto-refresh-label{font-size:0.8rem;color:var(--text-secondary)}
.refresh-dot{width:6px;height:6px;border-radius:50%;background:var(--success);display:inline-block;margin-left:4px;animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
</style>
</head>
<body>
<a class="back-link" href="management.html">&larr; Back to Management Panel</a>
<h1>Detailed Request Logs</h1>
<p class="subtitle">Browse and inspect all proxied API requests with full request/response details, retry tracking, and per-API-key filtering.</p>

<div class="toolbar">
  <div class="toggle-group">
    <span class="toggle-label">Enable Detailed Logging</span>
    <label class="toggle">
      <input type="checkbox" id="toggleEnabled" onchange="toggleDetailedLog(this.checked)">
      <span class="slider"></span>
    </label>
  </div>
  <div class="auto-refresh-group">
    <span class="auto-refresh-label">Auto Refresh</span>
    <label class="toggle">
      <input type="checkbox" id="toggleAutoRefresh" checked onchange="toggleAutoRefresh(this.checked)">
      <span class="slider"></span>
    </label>
    <span id="refreshIndicator" class="refresh-dot"></span>
  </div>
  <div class="stats" id="statsInfo"></div>
  <button class="btn btn-sm btn-danger" onclick="deleteAll()">Clear All</button>
  <button class="btn btn-sm btn-primary" onclick="loadRecords()">Refresh</button>
</div>

<div class="filter-bar">
  <select id="apiKeyFilter" onchange="resetAndLoad()">
    <option value="">All API Keys</option>
  </select>
  <div class="status-chips" id="statusChips">
    <span class="chip active" data-status="" onclick="setStatusFilter(this,'')">All</span>
    <span class="chip" data-status="2xx" onclick="setStatusFilter(this,'2xx')">2xx</span>
    <span class="chip" data-status="4xx" onclick="setStatusFilter(this,'4xx')">4xx</span>
    <span class="chip" data-status="5xx" onclick="setStatusFilter(this,'5xx')">5xx</span>
  </div>
  <div class="time-range">
    <div class="time-presets">
      <span class="chip active" onclick="setTimePreset(this,0)">All</span>
      <span class="chip" onclick="setTimePreset(this,1)">1h</span>
      <span class="chip" onclick="setTimePreset(this,6)">6h</span>
      <span class="chip" onclick="setTimePreset(this,24)">1d</span>
      <span class="chip" onclick="setTimePreset(this,168)">1w</span>
    </div>
    <input type="datetime-local" id="timeAfter" oninput="onCustomTime()" onchange="onCustomTime()" step="1" title="From">
    <span class="time-label">-</span>
    <input type="datetime-local" id="timeBefore" oninput="onCustomTime()" onchange="onCustomTime()" step="1" title="To">
  </div>
</div>

<div id="cardList" class="card-list">
  <div class="loading">Loading...</div>
</div>

<div class="pagination" id="pagination"></div>

<script>
const API_BASE = window.location.origin + '/v0/management';
let currentOffset = 0;
const PAGE_SIZE = 100;
let currentStatusFilter = '';
let authKey = '';
let isEmbed = false;
let autoRefreshEnabled = true;
let autoRefreshTimer = null;
const AUTO_REFRESH_INTERVAL = 2000; // 2 seconds

// Detect embed mode
(function() {
  var params = new URLSearchParams(window.location.search);
  if (params.get('embed') === '1') {
    isEmbed = true;
    document.body.classList.add('embed');
    // Try to inherit theme from parent
    try {
      if (window.parent && window.parent !== window) {
        var parentStyle = window.parent.getComputedStyle(window.parent.document.documentElement);
        // Read common CSS variables from parent
        var vars = ['--bg-primary','--bg-secondary','--bg-tertiary','--text-primary','--text-secondary',
                     '--border-color','--accent-color','--success-color','--warning-color','--error-color'];
        vars.forEach(function(v) {
          var val = parentStyle.getPropertyValue(v);
          if (val && val.trim()) document.documentElement.style.setProperty(v, val.trim());
        });
      }
    } catch(e) { /* cross-origin or not available */ }
  }
})();

// Decryption utilities - mirrors the management panel's secureStorage encryption
var ENC_PREFIX = 'enc::v1::';
var SECRET_SALT = 'cli-proxy-api-webui::secure-storage';

function getKeyBytes() {
  var key = SECRET_SALT + '|' + window.location.host + '|' + navigator.userAgent;
  var encoder = new TextEncoder();
  return encoder.encode(key);
}

function xorBytes(data, keyBytes) {
  var result = new Uint8Array(data.length);
  for (var i = 0; i < data.length; i++) {
    result[i] = data[i] ^ keyBytes[i % keyBytes.length];
  }
  return result;
}

function decryptStorage(payload) {
  if (!payload || !payload.startsWith(ENC_PREFIX)) return payload;
  try {
    var encoded = payload.slice(ENC_PREFIX.length);
    var binary = atob(encoded);
    var encrypted = new Uint8Array(binary.length);
    for (var i = 0; i < binary.length; i++) encrypted[i] = binary.charCodeAt(i);
    var decrypted = xorBytes(encrypted, getKeyBytes());
    return new TextDecoder().decode(decrypted);
  } catch(e) { return payload; }
}

function tryGetAuthFromStorage() {
  try {
    var raw = localStorage.getItem('cli-proxy-auth');
    if (!raw) return '';
    var decrypted = decryptStorage(raw);
    var parsed = JSON.parse(decrypted);
    // zustand persist format: { state: { managementKey: '...', ... }, version: 0 }
    if (parsed && parsed.state && parsed.state.managementKey) {
      return parsed.state.managementKey;
    }
    // fallback: direct key
    if (parsed && parsed.managementKey) {
      return parsed.managementKey;
    }
  } catch(e) { /* ignore */ }
  return '';
}

// Try to get auth key from localStorage (shared with management panel)
(function() {
  var stored = tryGetAuthFromStorage();
  if (stored) {
    authKey = stored;
  }
})();

function getAuthHeaders() {
  if (!authKey) {
    if (isEmbed) {
      // In embed mode, try localStorage again (parent may have just logged in)
      var stored = tryGetAuthFromStorage();
      if (stored) { authKey = stored; }
    }
    if (!authKey) {
      authKey = prompt('Enter management key:');
      if (!authKey) return {};
    }
  }
  return {'Authorization': 'Bearer ' + authKey, 'Content-Type': 'application/json'};
}

async function apiFetch(url, options = {}) {
  const headers = getAuthHeaders();
  if (!headers.Authorization) return null;
  options.headers = {...headers, ...(options.headers||{})};
  try {
    const resp = await fetch(url, options);
    if (resp.status === 401) { authKey = ''; alert('Invalid management key'); return null; }
    return resp;
  } catch(e) { console.error(e); return null; }
}

async function loadStatus() {
  const resp = await apiFetch(API_BASE + '/detailed-request-log');
  if (!resp) return;
  const data = await resp.json();
  document.getElementById('toggleEnabled').checked = data['detailed-request-log'];
  const stats = document.getElementById('statsInfo');
  if (data.record_count !== undefined) {
    stats.innerHTML = '<span>' + data.record_count + ' records</span><span>' + (data.size_mb || '0') + ' MB</span>';
  }
}

async function toggleDetailedLog(enabled) {
  await apiFetch(API_BASE + '/detailed-request-log', {
    method: 'PUT',
    body: JSON.stringify({value: enabled})
  });
  loadStatus();
}

function setStatusFilter(el, status) {
  currentStatusFilter = status;
  document.querySelectorAll('#statusChips .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  currentOffset = 0;
  lastRecordIds = '';
  loadRecords();
}

let lastRecordIds = ''; // track record IDs to detect changes
let isFirstLoad = true;
let isLoading = false;

// Save the full UI state: card expanded, request-block open, headers-section open
function saveUIState(container) {
  const state = {};
  container.querySelectorAll('.card').forEach(card => {
    const cardId = card.id.replace('card-', '');
    if (!cardId) return;
    const cardState = { expanded: card.classList.contains('expanded'), sections: {}, headers: {} };
    // Track each request-block / response-block open state by data-section
    card.querySelectorAll('.request-block[data-section]').forEach(block => {
      cardState.sections[block.getAttribute('data-section')] = block.classList.contains('open');
    });
    // Track headers-section open state by parent data-section
    card.querySelectorAll('.request-block[data-section] .headers-section').forEach(hs => {
      const parentSection = hs.closest('.request-block[data-section]');
      if (parentSection) {
        cardState.headers[parentSection.getAttribute('data-section')] = hs.classList.contains('open');
      }
    });
    state[cardId] = cardState;
  });
  return state;
}

function restoreUIState(container, state) {
  for (const [cardId, cardState] of Object.entries(state)) {
    const card = document.getElementById('card-' + cardId);
    if (!card) continue;
    if (cardState.expanded) card.classList.add('expanded');
    // Restore section open states
    for (const [sectionName, isOpen] of Object.entries(cardState.sections)) {
      const block = card.querySelector('.request-block[data-section="' + sectionName + '"]');
      if (block) {
        if (isOpen) block.classList.add('open');
        else block.classList.remove('open');
      }
    }
    // Restore headers open states
    for (const [sectionName, isOpen] of Object.entries(cardState.headers)) {
      const block = card.querySelector('.request-block[data-section="' + sectionName + '"]');
      if (block) {
        const hs = block.querySelector('.headers-section');
        if (hs) {
          if (isOpen) hs.classList.add('open');
          else hs.classList.remove('open');
        }
      }
    }
  }
}

function resetAndLoad() {
  currentOffset = 0;
  lastRecordIds = '';
  loadRecords();
}

let activeTimePresetHours = 0; // 0 = all

function setTimePreset(el, hours) {
  activeTimePresetHours = hours;
  document.querySelectorAll('.time-presets .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  if (hours === 0) {
    document.getElementById('timeAfter').value = '';
    document.getElementById('timeBefore').value = '';
  } else {
    const now = new Date();
    const from = new Date(now.getTime() - hours * 3600000);
    document.getElementById('timeAfter').value = toLocalISOString(from);
    document.getElementById('timeBefore').value = '';
  }
  resetAndLoad();
}

function onCustomTime() {
  activeTimePresetHours = -1;
  document.querySelectorAll('.time-presets .chip').forEach(c => c.classList.remove('active'));
  resetAndLoad();
}

function toLocalISOString(d) {
  const pad = n => String(n).padStart(2, '0');
  return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) +
    'T' + pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());
}

async function loadRecords(silent) {
  if (isLoading) return;
  isLoading = true;

  const apiKeyHash = document.getElementById('apiKeyFilter').value;
  let url = API_BASE + '/detailed-requests?limit=' + PAGE_SIZE + '&offset=' + currentOffset;
  if (apiKeyHash) url += '&api_key=' + encodeURIComponent(apiKeyHash);
  if (currentStatusFilter) url += '&status_code=' + encodeURIComponent(currentStatusFilter);
  // For presets, recalculate "after" relative to now (rolling window)
  if (activeTimePresetHours > 0) {
    const from = new Date(Date.now() - activeTimePresetHours * 3600000);
    url += '&after=' + Math.floor(from.getTime() / 1000);
  } else {
    const afterVal = document.getElementById('timeAfter').value;
    if (afterVal) url += '&after=' + Math.floor(new Date(afterVal).getTime() / 1000);
  }
  const beforeVal = document.getElementById('timeBefore').value;
  if (beforeVal) url += '&before=' + Math.floor(new Date(beforeVal).getTime() / 1000);

  const container = document.getElementById('cardList');

  // Only show loading spinner on first load
  if (isFirstLoad) {
    container.innerHTML = '<div class="loading">Loading...</div>';
  }

  const resp = await apiFetch(url);
  isLoading = false;
  if (!resp) {
    if (isFirstLoad) container.innerHTML = '<div class="empty-state"><h3>Failed to load</h3></div>';
    return;
  }
  const data = await resp.json();
  isFirstLoad = false;

  // Update API key filter dropdown (preserve selection)
  const select = document.getElementById('apiKeyFilter');
  const savedVal = select.value;
  select.innerHTML = '<option value="">All API Keys</option>';
  (data.api_keys || []).forEach(k => {
    const opt = document.createElement('option');
    opt.textContent = k;
    opt.value = k;
    select.appendChild(opt);
  });
  select.value = savedVal;

  const records = data.records || [];
  const total = data.total || 0;

  // Build a fingerprint of current record IDs to detect changes
  const newIds = records.map(r => r.id + ':' + r.status_code).join(',');

  if (records.length === 0) {
    container.innerHTML = '<div class="empty-state"><h3>No records found</h3><p>Enable detailed logging and make some API requests to see them here.</p></div>';
    document.getElementById('pagination').innerHTML = '';
    lastRecordIds = '';
    loadStatus();
    return;
  }

  // Only re-render if data changed (avoids flicker on auto-refresh)
  if (newIds !== lastRecordIds) {
    // Save all open/expanded states within each card
    const uiState = saveUIState(container);

    container.innerHTML = records.map(r => renderCard(r)).join('');

    // Restore all states
    restoreUIState(container, uiState);

    lastRecordIds = newIds;
  }

  // Pagination
  const pag = document.getElementById('pagination');
  const totalPages = Math.ceil(total / PAGE_SIZE);
  const currentPage = Math.floor(currentOffset / PAGE_SIZE) + 1;
  let pagHtml = '';
  if (currentOffset > 0) pagHtml += '<button class="btn btn-sm btn-ghost" onclick="goPage(-1)">&laquo; Prev</button>';
  pagHtml += '<span>Page ' + currentPage + ' of ' + totalPages + ' (' + total + ' total)</span>';
  if (currentOffset + PAGE_SIZE < total) pagHtml += '<button class="btn btn-sm btn-ghost" onclick="goPage(1)">Next &raquo;</button>';
  pag.innerHTML = pagHtml;

  loadStatus();
}

function goPage(dir) {
  currentOffset += dir * PAGE_SIZE;
  if (currentOffset < 0) currentOffset = 0;
  lastRecordIds = '';
  loadRecords();
}

function statusClass(code) {
  if (code >= 500) return 'status-5xx';
  if (code >= 400) return 'status-4xx';
  if (code >= 300) return 'status-3xx';
  if (code >= 200) return 'status-2xx';
  return 'status-0';
}

function fmtTime(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  return d.toLocaleTimeString('en-US', {hour12:false}) + '.' + String(d.getMilliseconds()).padStart(3,'0');
}

function fmtDate(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  return d.toLocaleDateString('zh-CN') + ' ' + d.toLocaleTimeString('en-US', {hour12:false});
}

function escHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatJson(s) {
  if (!s) return '';
  try { return JSON.stringify(JSON.parse(s), null, 2); } catch(e) { return s; }
}

// Render headers in "Key: Value" format with color coding
function renderHeadersHtml(headers) {
  if (!headers || Object.keys(headers).length === 0) return '';
  // Sort header keys for consistent display
  const keys = Object.keys(headers).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
  let html = '';
  for (const key of keys) {
    const values = headers[key];
    for (const val of values) {
      html += '<div class="header-line">' +
        '<span class="header-key">' + escHtml(key) + '</span>' +
        '<span class="header-sep">: </span>' +
        '<span class="header-val">' + escHtml(val) + '</span>' +
      '</div>';
    }
  }
  return html;
}

// Count total headers
function headerCount(headers) {
  if (!headers) return 0;
  let count = 0;
  for (const key of Object.keys(headers)) {
    count += headers[key].length;
  }
  return count;
}

// Render a combined request/response block with collapsible headers + body
// sectionId is used for preserving open/close state across refreshes
function renderBlock(title, headers, body, sectionId, labelClass, defaultOpen) {
  const hasHeaders = headers && Object.keys(headers).length > 0;
  const hasBody = body && body !== '{}' && body !== '""';
  if (!hasHeaders && !hasBody) return '';

  const openClass = defaultOpen ? ' open' : '';
  const hCount = headerCount(headers);
  const formattedBody = formatJson(body);
  const titleClass = labelClass ? ' ' + labelClass : '';

  let inner = '';

  // Headers section (collapsible, default collapsed)
  if (hasHeaders) {
    inner += '<div class="headers-section">' +
      '<div class="headers-toggle" onclick="this.parentElement.classList.toggle(\'open\')">' +
        '<span class="arrow">&#9654;</span> Headers <span style="color:var(--text-secondary);font-size:0.7rem;margin-left:4px">(' + hCount + ')</span>' +
      '</div>' +
      '<div class="headers-list">' + renderHeadersHtml(headers) + '</div>' +
    '</div>';
  }

  // Body content
  if (hasBody) {
    inner += '<div class="body-content">' + escHtml(formattedBody) + '</div>';
  }

  return '<div class="request-block' + openClass + '" data-section="' + escHtml(sectionId) + '">' +
    '<div class="request-block-title' + titleClass + '" onclick="this.parentElement.classList.toggle(\'open\')">' +
      '<span class="arrow">&#9654;</span> ' + escHtml(title) +
    '</div>' +
    '<div class="request-block-content">' + inner + '</div>' +
  '</div>';
}

function renderCard(r) {
  const attempts = r.attempts || [];
  const attemptCount = attempts.length;
  const retries = attemptCount > 1 ? ' (' + (attemptCount-1) + ' retries)' : '';

  return '<div class="card" id="card-' + r.id + '">' +
    '<div class="card-header" onclick="toggleCard(\'' + r.id + '\')">' +
      '<span class="expand-icon">&#9654;</span>' +
      '<span class="method-badge">' + escHtml(r.method) + '</span>' +
      '<span class="path">' + escHtml(r.url) + '</span>' +
      (r.model ? '<span class="model-badge">' + escHtml(r.model) + '</span>' : '') +
      '<span class="status-badge ' + statusClass(r.status_code) + '">' + r.status_code + '</span>' +
      '<div class="meta">' +
        (r.api_key ? '<span class="api-key-tag">' + escHtml(r.api_key) + '</span>' : '') +
        '<span class="meta-item duration">' + r.total_duration_ms + 'ms</span>' +
        (attemptCount > 0 ? '<span class="meta-item">' + attemptCount + ' attempt' + (attemptCount>1?'s':'') + retries + '</span>' : '') +
        '<span class="timestamp">' + fmtTime(r.timestamp) + '</span>' +
      '</div>' +
    '</div>' +
    '<div class="card-body">' +
      '<div class="actions">' +
        '<button class="btn btn-sm btn-primary" onclick="copyCurl(\'' + r.id + '\')">Copy cURL</button>' +
        '<span class="timestamp">' + fmtDate(r.timestamp) + '</span>' +
        (r.is_streaming ? '<span class="model-badge">Streaming</span>' : '') +
      '</div>' +
      renderBlock('Client Request', r.request_headers, r.request_body, 'client-request', '', true) +
      renderAttempts(attempts) +
      renderBlock('Final Response', r.response_headers, r.response_body, 'final-response', statusClass(r.status_code) === 'status-2xx' ? 'section-label-success' : (r.status_code >= 400 ? 'section-label-error' : ''), true) +
      (r.error ? renderErrorSection(r.error) : '') +
    '</div>' +
  '</div>';
}

function renderAttempts(attempts) {
  if (!attempts || attempts.length === 0) return '';
  return attempts.map((a, i) => {
    const label = i === 0 ? 'Initial Request' : 'Retry ' + i;
    const statusCls = a.status_code ? statusClass(a.status_code) : 'status-0';
    return '<div class="attempt-card">' +
      '<div class="attempt-header">' +
        '<span class="attempt-label">' + label + ' (#' + a.index + ')</span>' +
        (a.status_code ? '<span class="status-badge attempt-status ' + statusCls + '">' + a.status_code + '</span>' : '') +
        (a.upstream_url ? '<span class="path" style="font-size:0.7rem">' + escHtml(a.upstream_url) + '</span>' : '') +
        (a.auth ? '<span class="api-key-tag">' + escHtml(a.auth) + '</span>' : '') +
      '</div>' +
      renderBlock('Upstream Request', a.request_headers, a.request_body, 'attempt-' + i + '-req', '', false) +
      renderBlock('Upstream Response', a.response_headers, a.response_body, 'attempt-' + i + '-resp', a.status_code >= 400 ? 'section-label-error' : '', false) +
      (a.error ? '<div style="color:var(--error);font-size:0.8rem;margin-top:4px;padding:8px 12px;background:rgba(220,38,38,0.06);border-radius:6px">Error: ' + escHtml(a.error) + '</div>' : '') +
    '</div>';
  }).join('');
}

function renderErrorSection(error) {
  if (!error) return '';
  return '<div class="request-block open" data-section="error" style="margin-top:14px">' +
    '<div class="request-block-title section-label-error">' +
      '<span class="arrow" style="transform:rotate(90deg)">&#9654;</span> Error' +
    '</div>' +
    '<div class="request-block-content">' +
      '<div class="body-content" style="color:var(--error)">' + escHtml(error) + '</div>' +
    '</div>' +
  '</div>';
}

// Legacy section renderer (kept for backward compat but unused in new cards)
function renderSection(title, content) {
  if (!content || content === '{}' || content === '""') return '';
  return '<div class="section">' +
    '<div class="section-title" onclick="this.parentElement.classList.toggle(\'open\')">' +
      '<span class="arrow">&#9654;</span> ' + escHtml(title) +
    '</div>' +
    '<div class="section-content">' + escHtml(content) + '</div>' +
  '</div>';
}

function toggleCard(id) {
  const card = document.getElementById('card-' + id);
  if (card) card.classList.toggle('expanded');
}

async function copyCurl(id) {
  const resp = await apiFetch(API_BASE + '/detailed-requests/' + id);
  if (!resp) return;
  const data = await resp.json();
  if (data.curl) {
    navigator.clipboard.writeText(data.curl).then(() => showToast('cURL copied!')).catch(() => {
      // Fallback
      const ta = document.createElement('textarea');
      ta.value = data.curl;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      showToast('cURL copied!');
    });
  }
}

async function deleteAll() {
  if (!confirm('Delete all detailed request records?')) return;
  await apiFetch(API_BASE + '/detailed-requests', {method: 'DELETE'});
  lastRecordIds = '';
  loadRecords();
}

function showToast(msg) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 2500);
}

function toggleAutoRefresh(enabled) {
  autoRefreshEnabled = enabled;
  const dot = document.getElementById('refreshIndicator');
  if (enabled) {
    dot.style.display = 'inline-block';
    startAutoRefresh();
  } else {
    dot.style.display = 'none';
    stopAutoRefresh();
  }
}

function startAutoRefresh() {
  stopAutoRefresh();
  if (!autoRefreshEnabled) return;
  autoRefreshTimer = setInterval(() => {
    if (autoRefreshEnabled && currentOffset === 0) {
      loadRecords();
    }
  }, AUTO_REFRESH_INTERVAL);
}

function stopAutoRefresh() {
  if (autoRefreshTimer) {
    clearInterval(autoRefreshTimer);
    autoRefreshTimer = null;
  }
}

// Init
loadStatus();
loadRecords();
startAutoRefresh();
</script>
</body>
</html>
