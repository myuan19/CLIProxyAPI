# CLIProxyAPI 格式转换架构

## 1. 整体概览

CLIProxyAPI 是一个多格式 AI API 代理，核心能力是在不同 API 格式之间进行**双向自动转换**。客户端可以使用任意一种支持的格式发送请求，代理会自动将其转换为上游 provider 所需的格式，并将响应转换回客户端期望的格式。

```
客户端 (任意格式)                                    上游 Provider
      │                                                   ▲
      ▼                                                   │
┌──────────────────────────────────────────────────────────┐
│                      CLIProxyAPI                         │
│                                                          │
│  ┌────────────┐   ┌────────────┐   ┌──────────────────┐ │
│  │  API 端点   │──▶│ Handler 层 │──▶│   Executor 层    │ │
│  │ (路由入口)  │   │ (预处理)    │   │ (翻译+发请求)    │ │
│  └────────────┘   └────────────┘   └──────────────────┘ │
│                                          │    ▲          │
│                                          ▼    │          │
│                                    ┌──────────────┐      │
│                                    │ 翻译器注册表  │      │
│                                    │  (Registry)  │      │
│                                    └──────────────┘      │
└──────────────────────────────────────────────────────────┘
```

## 2. 支持的格式 (Format)

定义在 `sdk/translator/formats.go`：

| Format 常量 | 值 | 说明 |
|---|---|---|
| `FormatOpenAI` | `"openai"` | OpenAI Chat Completions 格式 (messages) |
| `FormatOpenAIResponse` | `"openai-response"` | OpenAI Responses 格式 (input) |
| `FormatClaude` | `"claude"` | Anthropic Claude 格式 |
| `FormatGemini` | `"gemini"` | Google Gemini 格式 |
| `FormatGeminiCLI` | `"gemini-cli"` | Google Gemini CLI 格式 |
| `FormatCodex` | `"codex"` | OpenAI Codex (Responses API via ChatGPT) |
| `FormatAntigravity` | `"antigravity"` | Antigravity provider 格式 |

### OpenAI 两种格式的区别

| | Chat Completions (`openai`) | Responses (`openai-response`) |
|---|---|---|
| 消息字段 | `"messages": [...]` | `"input": [...]` |
| 系统提示 | `{"role":"system", "content":"..."}` | `"instructions": "..."` |
| 内容类型 | `"content": "text"` | `{"type":"input_text", "text":"..."}` |
| 工具调用 | `assistant.tool_calls[]` | 顶层 `function_call` 对象 |
| 最大 token | `max_tokens` | `max_output_tokens` |

## 3. API 端点与请求入口

定义在 `internal/api/server.go` 的 `setupRoutes()`：

| 端点 | Handler | 入站格式 |
|---|---|---|
| `POST /v1/chat/completions` | `OpenAIAPIHandler.ChatCompletions` | OpenAI (messages) / Responses (input) |
| `POST /v1/completions` | `OpenAIAPIHandler.Completions` | OpenAI Completions (prompt) |
| `POST /v1/responses` | `OpenAIResponsesAPIHandler.Responses` | OpenAI Responses (input) |
| `POST /v1/messages` | `ClaudeCodeAPIHandler.ClaudeMessages` | Claude |
| `POST /v1beta/models/*action` | `GeminiAPIHandler.GeminiHandler` | Gemini |
| `POST /v1internal:method` | `GeminiCLIAPIHandler.CLIHandler` | Gemini CLI |

所有 `/v1/*` 路由都经过 `wrapWithUnifiedRouting` 包装，用于统一路由（智能代理）支持。

## 4. Handler 层 - 预处理

Handler 层负责在请求到达翻译器之前进行格式归一化。

### 4.1 ChatCompletions Handler

文件：`sdk/api/handlers/openai/openai_handlers.go`

```
ChatCompletions(rawJSON)
  │
  ├── shouldTreatAsResponsesFormat(rawJSON) ?
  │     有 messages → false (标准 Chat Completions)
  │     无 messages + 有 input → true (Responses 格式)
  │     无 messages + 有 instructions → true (Responses 格式)
  │
  ├── [如果是 Responses 格式]
  │     ConvertOpenAIResponsesRequestToOpenAIChatCompletions()
  │     将 input → messages, instructions → system message,
  │     max_output_tokens → max_tokens, reasoning.effort → reasoning_effort
  │
  ├── stream ?
  │     ├── true  → handleStreamingResponse()
  │     └── false → handleNonStreamingResponse()
  │
  └── ExecuteWithAuthManager() / ExecuteStreamWithAuthManager()
```

### 4.2 Completions Handler

```
Completions(rawJSON)
  │
  └── convertCompletionsRequestToChatCompletions()
        将 prompt → messages[{role:"user", content: prompt}]
        然后复用 Chat Completions 的执行路径
```

### 4.3 统一路由 (Unified Routing / 智能代理)

文件：`internal/api/server.go`

统一路由在 Handler 层之前拦截请求。如果请求的 model 名是路由别名，则绕过 Handler 直接进入 Executor 层。

```
wrapWithUnifiedRoutingFormat(request)
  │
  ├── unified routing 未启用？→ 透传给原始 Handler
  │
  ├── model 是路由别名？
  │     ├── [是] → normalizeResponsesFormat()     ← 格式归一化 (修复补丁)
  │     │          将 input/instructions 转为 messages
  │     │          → executeWithUnifiedRoutingFailoverFormat()
  │     │            → AuthManager.ExecuteWithAuth() / ExecuteStreamWithAuth()
  │     │              → executor.Execute() / executor.ExecuteStream()
  │     │
  │     └── [否] → hide_original_models ?
  │                 ├── true  → 404 model not found
  │                 └── false → 透传给原始 Handler
```

> **注意**：`normalizeResponsesFormat()` 是后续添加的修复。统一路由最初缺少
> `input → messages` 的格式归一化，导致使用 Responses 格式的请求走统一路由时，
> 下游翻译器找不到 `messages` 字段而报错 `INVALID_ARGUMENT`。

## 5. 翻译器注册表 (Registry)

核心文件：`sdk/translator/registry.go` + `sdk/translator/pipeline.go`

### 5.1 注册机制

翻译器通过 `init()` 函数自动注册到全局 `Registry`，格式为 `Register(from, to, requestFn, responseFn)`。

所有翻译器在 `internal/translator/init.go` 中通过 `_` import 触发注册。

### 5.2 翻译矩阵

每个 Provider 目标格式都注册了来自多种源格式的翻译器：

```
internal/translator/
├── antigravity/          # 目标: Antigravity
│   ├── openai/
│   │   ├── chat-completions/   # openai → antigravity
│   │   └── responses/          # openai-response → antigravity
│   ├── claude/                 # claude → antigravity
│   └── gemini/                 # gemini → antigravity
│
├── codex/                # 目标: Codex (ChatGPT Responses API)
│   ├── openai/
│   │   ├── chat-completions/   # openai → codex
│   │   └── responses/          # openai-response → codex
│   ├── claude/                 # claude → codex
│   ├── gemini/                 # gemini → codex
│   └── gemini-cli/             # gemini-cli → codex
│
├── claude/               # 目标: Claude API
│   ├── openai/
│   │   ├── chat-completions/   # openai → claude
│   │   └── responses/          # openai-response → claude
│   ├── gemini/                 # gemini → claude
│   └── gemini-cli/             # gemini-cli → claude
│
├── gemini/               # 目标: Gemini API
│   ├── openai/
│   │   ├── chat-completions/   # openai → gemini
│   │   └── responses/          # openai-response → gemini
│   ├── gemini/                 # gemini → gemini (passthrough/normalize)
│   ├── gemini-cli/             # gemini-cli → gemini
│   └── claude/                 # claude → gemini
│
├── gemini-cli/           # 目标: Gemini CLI API
│   ├── openai/
│   │   ├── chat-completions/   # openai → gemini-cli
│   │   └── responses/          # openai-response → gemini-cli
│   ├── gemini/                 # gemini → gemini-cli
│   └── claude/                 # claude → gemini-cli
│
└── openai/               # 目标: OpenAI 格式 (用于响应回转)
    ├── openai/
    │   ├── chat-completions/   # openai → openai (passthrough)
    │   └── responses/          # openai-response ↔ openai (格式互转)
    ├── claude/                 # claude → openai
    ├── gemini/                 # gemini → openai
    └── gemini-cli/             # gemini-cli → openai
```

### 5.3 翻译器内部结构

每个翻译器包含：
- **Request 翻译函数**：`func(modelName string, rawJSON []byte, stream bool) []byte`
- **Response 翻译函数**：
  - `Stream`: `func(ctx, model, origReq, transReq, rawJSON, param) []string`
  - `NonStream`: `func(ctx, model, origReq, transReq, rawJSON, param) string`

所有翻译器都从 `gjson.GetBytes(rawJSON, "messages")` 读取消息内容，这也是为什么入站请求必须先归一化为 `messages` 格式。

## 6. Executor 层 - 执行与翻译

文件：`internal/runtime/executor/*_executor.go`

| Executor | Provider | 目标格式 |
|---|---|---|
| `CodexExecutor` | Codex (ChatGPT) | codex |
| `ClaudeExecutor` | Anthropic | claude |
| `GeminiExecutor` | Google Gemini | gemini |
| `GeminiCLIExecutor` | Google Gemini CLI | gemini-cli |
| `AntigravityExecutor` | Antigravity | antigravity |
| `OpenAICompatExecutor` | OpenAI 兼容 | openai (passthrough) |
| `GeminiVertexExecutor` | Vertex AI | gemini |
| `AIStudioExecutor` | AI Studio | gemini |
| `IFlowExecutor` | IFlow | 自定义 |
| `QwenExecutor` | Qwen | 自定义 |

Executor 的执行流程：

```
executor.Execute(ctx, auth, req, opts)
  │
  ├── 1. 翻译请求
  │     TranslateRequest(sourceFormat → targetFormat, rawJSON)
  │     例: openai → antigravity
  │     将 messages[] 转为 contents[] + systemInstruction
  │
  ├── 2. 应用 thinking 参数 (如需要)
  │     thinking.ApplyThinking(body, model, ...)
  │
  ├── 3. 构建上游 URL 和 Headers
  │     applyHeaders(httpReq, auth, ...)
  │
  ├── 4. 发送 HTTP 请求 (支持代理)
  │     httpClient := newProxyAwareHTTPClient(...)
  │     httpResp := httpClient.Do(httpReq)
  │
  ├── 5. 翻译响应
  │     TranslateResponse(targetFormat → sourceFormat, responseBody)
  │     例: antigravity → openai
  │
  └── 6. 返回给上层
```

## 7. 完整请求生命周期

以 `POST /v1/chat/completions` + `"model": "gpt-5.2"` (统一路由别名) 为例：

```
客户端请求: {"model":"gpt-5.2", "input":[...], "stream":true}
  │
  ▼
[1] Gin Router → /v1/chat/completions
  │
  ▼
[2] AuthMiddleware → 验证 API Key
  │
  ▼
[3] wrapWithUnifiedRoutingFormat()
  │  读取 body, 提取 model="gpt-5.2"
  │  查询路由表 → 匹配路由别名
  │
  ▼
[4] normalizeResponsesFormat()
  │  检测到有 input 无 messages
  │  → ConvertOpenAIResponsesRequestToOpenAIChatCompletions()
  │  → {"model":"gpt-5.2", "messages":[...], "stream":true}
  │
  ▼
[5] executeWithUnifiedRoutingFailoverFormat()
  │  获取路由决策 (Pipeline → Layers → Targets)
  │  按 Layer 顺序尝试, 每个 Layer 内按策略选 Target
  │
  ▼
[6] AuthManager.ExecuteStreamWithAuth(targetAuth, req, opts)
  │  设置代理/RoundTripper
  │  应用模型名重写
  │
  ▼
[7] AntigravityExecutor.ExecuteStream()
  │  TranslateRequest(openai → antigravity):
  │    messages → contents + systemInstruction
  │  构建 HTTP 请求, 设置 Auth Headers
  │  发送到上游
  │
  ▼
[8] 上游返回 SSE 流
  │  TranslateResponse(antigravity → openai):
  │    每个 chunk 从 Gemini 格式转为 OpenAI Chat Completions 格式
  │
  ▼
[9] 客户端收到 OpenAI 格式的 SSE 流
    data: {"choices":[{"delta":{"content":"..."}}]}
    data: [DONE]
```

## 8. 关键文件索引

| 文件路径 | 职责 |
|---|---|
| `sdk/translator/formats.go` | Format 常量定义 |
| `sdk/translator/registry.go` | 翻译器注册表 |
| `sdk/translator/pipeline.go` | 翻译管道 (中间件支持) |
| `internal/translator/init.go` | 所有翻译器的 import 注册 |
| `internal/translator/{target}/{source}/` | 具体翻译器实现 |
| `internal/api/server.go` | 路由注册 + 统一路由 + 格式归一化 |
| `sdk/api/handlers/openai/openai_handlers.go` | OpenAI 端点 Handler (预处理) |
| `sdk/api/handlers/openai/openai_responses_handlers.go` | Responses 端点 Handler |
| `sdk/cliproxy/auth/conductor.go` | AuthManager 执行调度 |
| `internal/runtime/executor/*_executor.go` | Provider 执行器 |
| `internal/translator/openai/openai/responses/` | openai-response ↔ openai 互转 |
